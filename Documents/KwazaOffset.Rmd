---
title: "Air quality offset calculations for KwaZamokuhle"
author: "Christiaan Pauw, Nova Instituut"
date: "15 June 2016"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
  word_document:
    toc: yes
    toc_depth: '4'
---

```{r global_options, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)

USER <- c("CJP", "AH", "BS")[1]

if (USER == "CJP") {
  wd <- "/Users/christiaanpauw/Documents/Rpakette/AQoffset/"
  setwd("/Users/christiaanpauw/Documents/Rpakette/AQoffset/")
  rdir <-  file.path(paste(wd, "R/", sep=""))
  datadir <- normalizePath(paste("Data/", sep = ""))
  datadir2 <- "~/Documents/AQ_DATA/Data/"
}

```

```{r}
library(AQoffset)
library(AQoffsetData)

wgs.proj <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
new.proj <- "+proj=utm +south +zone=35 +ellps=WGS84" 
kwa.proj <- "+proj=utm +zone=35 +south +datum=WGS84 +units=km +ellps=WGS84 +towgs84=0,0,0"
```

```{r}
kwazaUTM <- spTransform(kwaza, CRS("+proj=utm +zone=35 +south +datum=WGS84 +units=km +ellps=WGS84 +towgs84=0,0,0"))
kwazaUTM$n <- 1
kwazaUTM <- kwazaUTM[,grep("n", names(kwazaUTM@data))]
```

```{r echo=FALSE}
kr <- rasterize(kwazaUTM, r3, "n", fun="count")
levelplot(kr) + latticeExtra::layer(sp::sp.polygons(kwazaUTM, lwd = 0.25))
```


```{r echo=FALSE, message=FALSE}
#remove the other datasets here to save memory
#load(paste(datadir, "/kwaza_eskom_24h_camx.Rda", sep = ""))
load(paste(datadir, "/eskom.Rda", sep = ""))
#load(paste(datadir, "/kwaza_eskom_year_camx.Rda", sep = ""))
load(paste(datadir, "/kwaza_household_energyRaster.Rda", sep=""))

load(paste(datadir, "/EOP-fuel_users.Rda", sep=""))
kpext <- extent(KWA)
eskom.base <- eskom * 0.15
ylabel <- expression(paste("Distribution of daily average ", mu, g/m^{3}, "over 364 days"))
hylabel <- expression(paste("Distribution of daily average ", mu, g/m^{3}, "over 182 days"))
```

```{r echo=FALSE}
# sumIncidences
```

# Baseline scenario
## Baseline emissions
### Household emission sources

KwaZamokuhle is characterised by a high proportion of households who use coal for domestic cooking and heating. The importance of coal is visible in the results on the question on the main energy carrier for heating from the 2011 Census; these results are shown in the Table 1. 

```{r echo = FALSE, message=FALSE}
kwa_census_df <- KWA@data[, c("SP_Name", "Electricity", "Gas", "Paraffin", "Wood", "Coal", "Animal.dung", "None")]
kwa_census_fuel_df <- data.frame(SP_NAME = KWA@data$SP_NAME, 
                                 Fuel = rowSums(kwa_census_df[,5:7], na.rm = T),
                                 No_fuel = rowSums(kwa_census_df[,c(2:4,8)], na.rm = T))
kable(kwa_census_df, row.names = FALSE, caption = "Main energy carrier for heating from the 2011 Census")
cat("\n")
```

```{r echo=FALSE}
#levelplot(households[[-c(7:8)]], pretty = TRUE, par.settings=BuRdTheme, main = "Number of households by energy carrier \nused for heating: Census 2011", scales=list(draw=FALSE)) + addkwa()
```

It is clear that there are far fewer users of wood and dung than of coal. Because there are very few households who use wood that do not on occasion use coal as well, the responses for coal on the question "Mark ALL the energy carriers that you use for heating?" are used as an estimate for domestic solid fuel use. A summary is provided in Table 2. 
 
```{r echo = FALSE, message=FALSE}
kable(kwa_census_fuel_df, row.names = FALSE, caption = "Solid fuel use for heating from the 2011 Census")
```

It is known however that because the Census asks only a question about the *main* energy carrier, the number of solid fuel users are underestimated. The results of the survey lead to a substantially higher estimate compared to the census. The estimates of coal using households per sub-place derived from the household survey are shown in Table 3. It is clear that the number of coal using households derived from the survey results is substantially higher. 

```{r echo=FALSE, fmessage=FALSE}
kable(data.frame(coal.heat[!is.na(coal.heat[,2]), ], row.names = NULL), caption = "Estimated number of coal using households per subplace with upper and lower bound of the 95% confidence interval")
```

The approximate spatial distribution of the households by coal use are shown below. The high concentration of coal users in the southern and eastern parts of KwaZamokuhle is clear.  

```{r , echo = FALSE, message=FALSE}
pop2sp(coal.heat, SPDF = KWA, raster = TRUE, scales = list(draw = FALSE), refres = c(10,10), plot = TRUE, par.settings = BuRdTheme, resamp = TRUE,  main = "Approximate location of coal users for heating: \nPoint estimate with 95% CI ", sub="'Yes' is coal use, 'No' is no coal use", verbose = TRUE) + addkwa() + txtkwa()
```

Baseline emissions are calculated from the results of a domestic fuel use survey. The estimates for fuel consumption based on the household survey are shown in Table 4. Winter coal consumption is understandably higher than summer consumption. Once again KwaZamokuhle SP has the highest consumption. 

```{r echo=FALSE, message=FALSE}
names(dta) <- gsub("suburb", "", names(dta))
names(dta) <- gsub("households", "#HH", names(dta))
names(dta) <- gsub("month.kg", "kg/m", names(dta))
names(dta) <- gsub("perc", "%", names(dta))
names(dta) <- gsub("winter.ave", "ave(W)", names(dta))
names(dta) <- gsub("summer.ave", "ave(S)", names(dta))
names(dta) <- gsub("\\.", " ", names(dta))
row.names(dta) <- NULL
pander(dta, split.cells = 40, 
       split.table = Inf, 
       rownames = NULL, 
       caption = "Baseline coal use by Suburb")
```

## Baseline states

```{r echo=FALSE, message=FALSE}
eskom_kwa <- brick(extent(hh_24), ncol = ncol(hh_24), nrow = nrow(hh_24), nl = 364)

# At this piont you can use setValues for populate the eskom raster with different data
PM <- matrix(sapply(1:364 ,function(i) rep(ESKOMSO2PM[i,1] , nrow(hh_24) * ncol(hh_24))), ncol = 364)

# Change ppb to ug/m3: WHO 25C 1013mb 1ppb SO2 = 2.62 ug/m3
SO2 <- matrix(sapply(1:364 ,function(i) rep(ESKOMSO2PM[i,2] * 2.62 , nrow(hh_24) * ncol(hh_24))), ncol = 364)

# Set Values
eskom_kwa_proj_c_pm <- setValues(eskom_kwa, PM)
names(eskom_kwa_proj_c_pm)  <- paste("Eskom_24h_pm10", ESKOMSO2PM$yd)

eskom_kwa_proj_c_so2 <- setValues(eskom_kwa, SO2)
names(eskom_kwa_proj_c_so2)  <- paste("Eskom_24h_so2", ESKOMSO2PM$yd)

eskom_kwa_proj <- stack(eskom_kwa_proj_c_pm, eskom_kwa_proj_c_so2)
# The baseline scenario (complinace) is 15% of the project scenario
eskom_kwa_base <- eskom_kwa_proj * 0.15

# test
idd <- unlist(lapply(1:2, function(i) ifelse(grep(c("so2","pm10")[i], names(eskom_kwa_proj)), i, NA)))
a <- stackApply(eskom_kwa_proj, indices = idd, fun = max, na.rm = TRUE)
cellStats(a, max) == sapply(ESKOMSO2PM[,1:2] * matrix(rep(c(1, 2.62), nrow(ESKOMSO2PM)), ncol = 2, byrow = TRUE), max) # test
```

The modelled baseline PM10 and SO~2~ resulting from household emissions in KwaZamokuhle is shown below. The tiles represent the 25th and 50th percentiles, the mean and the 75th and 99th percentiles. The last tile in each row represent the standard deviation. 

```{r echo = FALSE, message=FALSE}
raster_dist_plot(resample(hh_24, raster(extent(hh_24), ncol =100, nrow=100)), multi = c("pm10", "so2"), th=BuRdTheme, mn = "Households (baseline)", sb = "182 days") + addkwa()
```

The distributions of the PM10 and SO~2~ are fairly similar but the concentration of PM10 is modelled to be higher. It is also clear that the concentration of both PM10 and SO~2~ decreases rapidly with distance from the household sources. 

\pagebreak
The modelled baseline secondary PM2.5 resulting from the Hendrina power station is shown below. 

```{r echo=FALSE}
raster_dist_plot(crop(eskom_kwa_base, kpext), multi = c("pm10", "so2"), mn = "Secondary sulphate particulates and SO2 from Hendrina PS\n in the baseline scenario in the region of KwaZamokuhle", sb = ylabel) + txtkwa() + addkwa() 
```

```{r Echo = TRUE}
kable(raster_dist_plot(eskom_kwa_base, multi = c("pm10", "so2"), tab_out = TRUE), digits = 2, caption = "Secondary sulphate particulates and SO2 from Hendrina PS in the baseline scenario in the region of KwaZamokuhle (annual ug/m3)")
```

### Exceedence of specified concentrations in the baseline scenario 

The count of days where the PM10 concentrations that resulted from household emissions and the industrial point source is modelled to exceed a specified level, is shown below for the baseline scenario. 

```{r echo = FALSE}
hh_pm10_exceed = count_exceed(hh_24, pol = "pm10", min = 50, max = 300, by = 50, knip = FALSE)
rasterVis::levelplot(hh_pm10_exceed, main = "Count of days when PM10 from households \nexceeded specified concentration", sub = "182 days", par.settings=viridisTheme()) + addkwa()
```

The exceedances of the daily PM10 standard related to household emissions occur over the southern and eastern side of KwaZamokuhle with the highest exceedance count at every level occurring in KwaZamokuhle SP.

```{r echo=FALSE}
#xl = expression(paste(mu,plain(g/m)^3))
# bar_exceed(hh_pm10_exceed, ttl = "Aggregated number of days when PM10 from households \nexceeded specified concentration", plot = FALSE)
count_exceed_table(hh_pm10_exceed)
```

As far as the Industrial point source is concerned, the baseline scenario is the compliance scenario. For this reasons the baseline emissions and the associated ambient concentrations are very low. 

```{r echo = FALSE}
eskom_pm10_exceed_base = count_exceed(eskom_kwa_base[[grep("pm", names(eskom_kwa_base))]], pol = NULL, min = 0, max = 20, by = 1, knip = TRUE)

eskom_pm10_exceed_proj = count_exceed(eskom_kwa_proj[[grep("pm", names(eskom_kwa_proj))]], pol = NULL, min = 1, max = 30, by = 5, knip = TRUE)

levelplot(eskom_pm10_exceed_base, main = "Count of days when concentrations of secondary PM from \nEskom exceeded specified concentration in the baseline scenario", sub = "364 days", scales=list(draw=FALSE), par.settings=BuRdTheme) + addkwa()

count_exceed_table(eskom_pm10_exceed_base, cp = "Count of days when concentrations of secondary PM from \nEskom exceeded specified concentration in the baseline scenario")
```

The count of days where SO~2~ from the industrial point source exceeded the specified level for the baseline scenario is shown below. 

```{r echo=FALSE}
eskom_so2_exceed_base = count_exceed(eskom_kwa_base[[grep("so2", names(eskom_kwa_base))]], pol = NULL, min = 0, max = 10, by = 1, knip = TRUE)

eskom_so2_exceed_proj = count_exceed(eskom_kwa_base[[grep("so2", names(eskom_kwa_proj))]], pol = NULL, min = 0, max = 10, by = 1, knip = TRUE)

levelplot(eskom_so2_exceed_base, main = "Count of days when secondary SO2 from \nEskom exceeded specified concentration in the baseline scenario", sub = "364 days", scales=list(draw=FALSE), par.settings=BuRdTheme) + addkwa()
```

```{r echo=FALSE}
#bar_exceed(eskom_pm10_exceed, ttl = "Aggregated of days when PM10 from Eskom \nexceeded specified concentration")
count_exceed_table(eskom_pm10_exceed_base, cp = "Baseline exceedence count: PM form Eskom")
```

\pagebreak
The count of days where SO~2~ concentration that resulted from household emissions is modelled to exceed a specified level, is shown below for the baseline scenario. 

```{r echo=FALSE}
hh_so2_exceed = count_exceed(hh_24, pol = "so2", min = 100, max = 300, by = 25, knip = FALSE)

levelplot(hh_so2_exceed, main = "Count of days when SO2 from households \nexceeded specified concentration", sub = "182 days", par = BuRdTheme, scales=list(draw=FALSE)) + addkwa() + txtkwa()
```

Occurrences of exceedances of the daily SO~2~ standard related to coal combustion from households are less common than that for PM10. The area over which such occurrences are smaller than that of PM10 for every level and the count of exceedances for each level is also less. Once again most exceedances occur in KwaZamokuhle SP. 

```{r echo=FALSE}
#bar_exceed(hh_so2_exceed, ttl = "Aggregated count of days when SO2 from \nhouseholds exceeded specified concentration")
count_exceed_table(hh_so2_exceed)
```

### Combined baseline states

```{r echo=FALSE, message=FALSE}
hh_24[is.na(hh_24)] <- 0
# subset for the same days of the year
yddE <- gsub("Eskom_24h_pm10.", "", grep("pm10", names(eskom_kwa_base), value = T))
yddE2 <- gsub("Eskom_24h_so2.", "", grep("so2", names(eskom_kwa_base), value = T))
ydd <- gsub("HH_pm10_24h.", "", grep("pm", names(hh_24), value = T)) 
ydd2 <- gsub("HH_so2_24h.", "", grep("so2", names(hh_24), value = T)) 
base_PM10_vals_hh <- getValues(hh_24[[grep("pm", names(hh_24))]])
base_PM10_vals_E <- getValues(eskom_kwa_base[[grep("pm", names(eskom_kwa_base))]])[match(ydd, yddE)]
base_PM10_vals <- base_PM10_vals_E + base_PM10_vals_hh

base_SO2_vals_hh <- getValues(hh_24[[grep("so2", names(hh_24))]])
base_SO2_vals_E <- getValues(eskom_kwa_base[[grep("so2", names(eskom_kwa_base))]])[match(ydd2, yddE2)]
base_SO2_vals <- base_SO2_vals_E + base_SO2_vals_hh

# a PM stack
allPM10_base <- stack(hh_24[[grep("pm", names(hh_24))]], eskom_kwa_base[[grep("pm10", names(eskom_kwa_base))]])
# get only the days of the year that correspond
yd <- gsub("Eskom_24h_pm10.|Households_pm10_24h.", "", names(allPM10_base))
corrdays <- yd[which(duplicated(yd))]
allPM10_base <- stackApply(allPM10_base, indices = match(yd , corrdays), sum)
names(allPM10_base) <- gsub("index_", "All_pm10_24h.", names(allPM10_base) )

# a SO2 stack
allSO2_base <- stack(hh_24[[grep("so2", names(hh_24))]], eskom_kwa_base[[grep("so2", names(eskom_kwa_base))]])
yd <- gsub("Eskom_24h_so2.|Households_so2_24h.", "", names(allSO2_base))
corrdays <- yd[which(duplicated(yd))]
allSO2_base <- stackApply(allSO2_base, indices = na.omit(match(yd , corrdays)), sum)
names(allSO2_base) <- gsub("index_", "All_so2_24h.", names(allSO2_base) )

# verenigde PM10 en SO2
all_base <- stack(allPM10_base, allSO2_base)
all_base <- all_base[[-grep("NA", names(all_base))]]
names(all_base) <- gsub("HH_", "All_", names(all_base))

combined_base <- stack(hh_24, eskom_kwa_base, all_base)
```

```{r echo=FALSE}
# create a people raster of the same extent as hh_24
households <- rasteriseCensus(KWA, ref = all_base, refres = c(nrow(all_base), ncol(all_base)), verbose = TRUE)
total_households <- calc(households, sum, na.rm = TRUE)
names(total_households) <- "Total_households"
total_households[total_households == 0] <- NA
people <- total_households*3.7
people[people==0] <- NA
names(people) <- "total"
all.equal(extent(people) , extent(all_base))
```


```{r echo=TRUE}
raster_dist_plot(resample(all_base, raster(extent(all_base), ncol = 100, nrow = 100)), multi = c("pm10", "so2"), meanonly = TRUE, mn = "Mean 24h baseline concentrations \nin the baseline scenario from households and Eskom", sb = hylabel) + addkwa() + txtkwa()
```

```{r echo=FALSE}
kable(raster_dist_plot(all_base, multi = c("pm10", "so2"),tab_out  = TRUE), caption = "Mean 24h baseline concentrations \nin the baseline scenario from households and Eskom (ug/m3 over 182 days)", digits = 2)
```

# Project boundary
The spatial extent of the project boundary is the overlapping extent of the ambient contribution of the baseline emissions above 2 ug/m3 per year or 19 ug/m3 per day in PM10 or SO~2~, and the same for project emissions from the managed activity. Project emissions from the managed activity are the emissions from Eskom in the business-as-usual scenario. Baseline emissions from households are the emissions from households before implementation of the intervention. 

## Application of thresholds to determine project boundary

The baseline emissions from household coal use are summarised below. The tiles represent the 1st, 25th and 50th percentiles, the mean and the 75th and 99th percentiles. The last three tiles represent the standard deviation, inter-quartile range and 99% range of the data. 

```{r echo=FALSE, message=FALSE}
raster_dist_plot(all_baseR, scales = list(TRUE), multi = c("pm10", "so2"), mn = "Definition of the project boundary", sb = hylabel, th=BuRdTheme) + addkwaR()
```

\pagebreak
The extent of the impact of household emissions in the baseline scenario above an annual average of 2ug/m3 or an daily average of 19ug/m3 is shown below. Blank cells are outside of the project boundary.

```{r echo = FALSE, message=FALSE}
masker <- project_boundary(r = hh_24, target_period = 'acute', only.mask = TRUE)
# Nie eskom nie want dan is daar nie 'n projek nie
#eskom_kwa_base <- project_boundary(r = eskom_kwa_base, target_period = 'acute', return.mask = FALSE)
hh_24 <- project_boundary(r = hh_24, target_period = 'acute', return.mask = FALSE)
eskom_kwa_proj <- resample(eskom_kwa_proj, hh_24)

all_base <- project_boundary(r = all_base, target_period = 'acute', return.mask = FALSE)

cat("\n")
raster_dist_plot(all_base, multi = c("pm10", "so2"), meanonly = FALSE, mn = expression(paste("Definition of the project boundary: 24h ", mu,g/m^{3})),  sb = "Non-blank areas are where daily or \n annual PM10 exceed the threshold (182 days)") + addkwa() + txtkwa()
```

Summary
```{r echo=FALSE}
raster_dist_plot(resample(all_base, raster(extent(all_base), ncol = 100, nrow=100)), multi = c("pm10", "so2"), meanonly = TRUE, mn = expression(paste("Definition of the project boundary: 24h ", mu,g/m^{3})),  sb = "Non-blank areas are where daily or \n annual PM10 exceed the threshold (182 days)") + addkwa() + txtkwa()
```

It is clear from the application of the threshold that, if the modelling is correct, the impact of domestic burning is localised in close proximity to the emissions. The project boundary includes the whole of the main place KwaZamokuhle. Of all the sub-places that make up the main place KwaZamokuhle, the highest mean and maximum concentrations are found in KwaZamokuhle SP. 

## Baseline impact

Baseline impact can be determined using different calculation approaches. Four approaches will be demonstrated. These are: 
1.  Health risk approach
2.  Particle equivalence approach
3.  Standards weighted intake
4.  Burden of disease approach

### Health risk approach

The health risk approach uses an air quality index based on the relative risk of short term mortality associated with every pollutant. Here the pollutants are PM10 and SO~2~, but O~3~ and NO~2~ can potentially be added. The baseline impact represents the combined impact of all pollutants. A summary of the daily API resulting from households is given below.  

```{r echo=FALSE}
kwaza_API <- rasterAPI(all_base, idpos = 1, polpos = 2, cyclepos = 5)
raster_dist_plot(kwaza_API,  multi = NULL,  mn = "Distribution of baseline API \nfor the baseline scenario", sb = "Air pollution index over 182 days") + addkwa() + txtkwa()

kable(raster_dist_plot(kwaza_API, tab_out = TRUE, multi = NULL), caption = "Distribution (mean of percentiles) of baseline API \nfor the baseline scenario", digits = 2)
```

```{r echo = FALSE}
raster_dist_plot(kwaza_API, meanonly = TRUE,
                 multi = NULL, 
                 mn = "Distribution of baseline API \nfor the baseline scenario",
                 sb = "Mean index value over 182 days") + addkwa() + txtkwa()
```

\pagebreak
The count of days where the baseline API is modelled to exceed a specified level is shown below for the baseline scenario. 

```{r echo=FALSE}
levelplot(count_exceed(kwaza_API, min = 3, max = 10, by = 1, knip = FALSE) , 
          par = BuRdTheme, 
          scales=list(draw=FALSE), 
          main = "Days in KwaZamokuhle where baseline API exceeded specified level", 
          sub = "182 days") + addkwa() + txtkwa()
```

KwaZamokuhle SP has the highest health risk related to short term exposure.  

### Particle equivalence approach

With sources that have a very localised dispersion, the particle equivalent impact (as PM10 equivalent) of that source is simply the concentration of the PM10 emitted by that source at every receptor; therefore, in the case of household emissions, the baseline impact is the same as the baseline state of PM10 shown above. 

The contribution of households and Eskom to particulate concentrations are shown below, first in detail and thereafter only the contribution to the 182 day mean. 

```{R echo = FALSE}
raster_dist_plot(crop(combined_baseR, hh_24), multi = c("Households_pm10_24h\\.","Eskom_24h_pm10\\.", "All_pm10_24h\\."), meanonly = TRUE, mn = "Baseline PM contribution", sb = hylabel) + addkwa() + txtkwa()
```

### Standards weighted intake

The standards weighted intake approach is roughly equivalent to a population weighted air pollution index with the index weights determined by the standard. In this way it is related to the health risk approach that also requires population data. 

```{r echo=FALSE, message=FALSE}
swi_base <- SWI(all_base, pop = people)
pp <- resample(crop(people, extent(swi_base)), raster(extent(all_base), nrow=100, ncol=100))

p1 <- rasterVis::levelplot(pp, par.settings = BuRdTheme, main = "Population density", margin = FALSE, scales = list(draw = FALSE)) + addkwa() + txtkwa()

p3 <- levelplot(resample(swi_base, raster(extent(all_base), ncol = 100, nrow=100)), par.settings = BuRdTheme, scales = list(draw = FALSE), main = "SWI: baseline scenario", margin = FALSE) + addkwa() + txtkwa()

grid.arrange(p1, p3, ncol=2)
```


### Burden of disease approach

The burden of disease approach quantifies the actual or expected incidence of adverse health outcomes attributible to the exposure to ambient air pollution, and expresses the impact of the air pollution in terms of the proportion or number of cases of a specific outcome or as a weighted aggregate of such outcomes.

The method requires estimates of the incidence rates as well as the total susseptible population of each of the outcomes to be quantified. The method furthermore requires concentration response functions for every outcome. If a monatary estimate of the impact is to be made, a cost estimate per case is also needed. In some cases the concentration response fucntion is defined for PM2.5 but exposure data is availible for PM10. I such cases one needs to make an assumption of the fraction of PM10 that is PM2.5. Chronic and acute effects have to be treated seperately. 

```{r echo = FALSE}
kable(summarise.sicklist(endlist)[,c(1:5, 12:15)],digits = 2, caption = "Assumptions for burden of disease calculations")
```

\pagebreak
The baseline burden of disease impact for PM10 in the baseline scenario is shown below.
```{r echo = FALSE, message=FALSE}
# estimate incidences
rBoDPM10 <- rasterCREP(sl = endlist,
                       pollutant = "PM10", 
                       cconc = all_base[[grep(pattern = "pm10", x = tolower(names(all_base)),
                                              fixed = TRUE)]], 
                       ppopr = people, 
                       bbase.conc = 10, 
                       rrisk.only = FALSE, 
                       verbose = FALSE, 
                       output = "AM",
                       ddelta = 1)

rBoDPM10 <- aggregateCREPstack(rBoDPM10)
# tabulate total incidences per health outcome
kable(sumIncidences(rBoDPM10), digits = 2)

# plot incidences
levelplot(crop(rBoDPM10, kpext), scales = list(draw = FALSE),
main = "Burden of disease for PM10 resulting from household emissions,
given as number of cases per health outcome", 
          sub = "182 days",
          par = BuRdTheme) + addkwa() + txtkwa()
```

\pagebreak
The baseline burden of disease impact for SO~2~ resulting from household emissions is shown below.
```{r echo=FALSE, message=FALSE}
rBoDSO2 <- rasterCREP(sl = endlist,
                      pollutant = "SO2", 
                      cconc = all_base[[grep(pattern = "so2", 
                                           x = tolower(names(all_base)), 
                                           fixed = TRUE)]], 
                      ppopr = people, 
                      bbase.conc = 10, 
                      rrisk.only = FALSE,
                      output = "AM",
                      verbose = FALSE,
                      ddelta = 1)

# summarise the number of cases across all days
rBoDSO2 <- aggregateCREPstack(rBoDSO2)

# tabulate total incidences per health outcome
kable(sumIncidences(rBoDSO2), digits = 2)

levelplot(crop(rBoDSO2, kpext),
          main = "Burden of disease for SO2 
resulting from hh emissions,
given as number of cases per health outcome",
          sub = "182 days",
          par = BuRdTheme) + addkwa() + txtkwa()
```

\pagebreak

# Project scenario

The project scenario is the implementation of a stove exchange for all RDP houses who use coal, where the households exchange their old coal stoves for a full retrofit and LPG.

The estimates of fuel users per house type are shown below.

```{r echo = FALSE}
kable(fuel_house[!is.na(fuel_house[,2]), ])
fh = fuel_house[which(fuel_house[,2] == "Fuel_RDP"), ]
fh$place = unique(fuel_house[,1])[c(1,3:6)]
```

The target for the project activity is therefore between `r colSums(fh[,3:5])["Lower"]`  and `r colSums(fh[,3:5])["Upper"] ` with a point estimate of `r colSums(fh[,3:5])["PointEst"] `

```{r echo=FALSE}
kable(fh, caption = "Implementation targets per sub-place")
```

## Project emissions

### Improvement per household

LPG 100%

Kitchen King = 0.018 * Union * 1.4 * 2 to be conservative ~ 5%

#### Proportion of solid fuel using households reachable by the project

### Project states

#### Project states from households

```{r echo = FALSE}
hh_24_proj <- hh_24 * 0.48
raster_dist_plot(hh_24_proj, mn = "Project states from households ", sb = "182 days", multi = c("pm10", "so2"), th=BuRdTheme) + addkwa() + txtkwa()
```

The number of high concentration events resulting from household emissions are modelled to decreased in the project scenario.

```{r echo=FALSE}
hh_24_proj_exceed_pm <- count_exceed(hh_24_proj, pol = "pm", min = 10, max= 100, by =10)

levelplot(resample(crop(hh_24_proj_exceed_pm, kpext), raster(kpext, ncol = 100, nrow = 100)), main = "Count of days when PM from households \nexceeded specified concentration in the project scenario", sub = "182 days", par = BuRdTheme, scales=list(draw=FALSE)) + addkwa() + txtkwa()

count_exceed_table(hh_24_proj_exceed_pm)
```

#### Project states from Eskom

A summary of the atmospheric states resulting from Eskom emissions in the project scenario over a period of 364 days is shown below. 
```{r echo = FALSE}
raster_dist_plot(eskom_kwa_proj, mn = "Modelled project states from Eskom", sb = ylabel, multi = c("pm10", "so2"), th=BuRdTheme) + addkwa() + txtkwa()
```

Eskom is modelled to contribute very little to high PM concentrations with most days modelled to have less than 6ug/m3 
```{r echo = FALSE}
#levelplot(eskom_pm10_exceed_proj, main = "Count of days when secondary PM from \nEskom exceeded specified concentration in the project scenario", sub = "364 days", scales=list(draw=FALSE), par.settings=BuRdTheme) + addkwa()

count_exceed_table(eskom_pm10_exceed_proj, cp = "Project exceedance count: PM from Eskom. Daily standard is 75")
```

SO~2~ from Eskom is also very low with no day modelled to have more than 5 ug/m3 of SO~2~ as a result of Eskom emissions
```{r echo = FALSE}
#levelplot(eskom_so2_exceed_proj, main = "Count of days when secondary SO2 from \nEskom exceeded specified concentration in the project scenario", sub = "364 days", scales=list(draw=FALSE), par.settings=BuRdTheme) + addkwa()

count_exceed_table(eskom_so2_exceed_proj, cp = "Project exceedance count: SO~2~ from Eskom. Daily standard is 125")
```

#### Project states (all sources)

In the project scenario, PM and SO2 emissions from households would be approximately 49% of the baseline scenario. Eskom emissions of SO~2~ in the project scenario is the business-as-usual emissions which is approximately 6.7 times higher than emissions in the compliance scenario (which is the baseline scenario). Since household emissions were only availible for 182 days, the combined comparison is only done for 182 days. 

```{r echo=FALSE, message=FALSE}

raster_dist_plot(hh_24_proj, mn = "Project states from Households", sb = ylabel, multi = c("pm10", "so2"), th=BuRdTheme) + addkwa() + txtkwa()
```

```{r echo=FALSE}
allPM10_proj <- stack(hh_24_proj[[grep("pm10", names(hh_24_proj))]], eskom_kwa_proj[[grep("pm10", names(eskom_kwa_proj))]])
yd <- gsub("Eskom_24h_pm10.|Households_pm10_24h.", "", names(allPM10_proj))
corrdays <- yd[which(duplicated(yd))]
allPM10_proj <- stackApply(allPM10_proj, indices = match(yd , corrdays), sum)
names(allPM10_proj) <- gsub("index_", "All_pm10_24h.", names(allPM10_proj))

allSO2_proj <- stack(hh_24_proj[[grep("so2", names(hh_24))]], eskom_kwa_proj[[grep("so2", names(eskom_kwa_proj))]])
yd <- gsub("Eskom_24h_so2.|Households_so2_24h.", "", names(allSO2_proj))
corrdays <- yd[which(duplicated(yd))]
allSO2_proj <- stackApply(allSO2_proj, indices = match(yd , corrdays), sum)
names(allSO2_proj) <- gsub("index_", "All_so2_24h.", names(allSO2_proj))

all_proj <- stack(allPM10_proj, allSO2_proj)

combined_proj <- stack(hh_24_proj, eskom_kwa_proj, all_proj)

raster_dist_plot(resample(all_proj, y = raster(extent(all_proj), nrow=100, ncol = 100)), multi = c("pm10", "so2"), mn = "Project states (all sources)", sb = hylabel) + addkwa() + txtkwa()
```

To summarise the project states, the mean concentrations resulting from households and Eskom as well as the mean combined project state is shown below.

### Project impacts

#### Project standards weighted intake

```{r echo=FALSE, message=FALSE}
swi_proj <- SWI(all_proj, pop = people)

swi_proj_p <- resample(swi_proj, raster(kpext, nrow=100, ncol =100))
pp <- resample(crop(people, extent(swi_proj_p)), raster(kpext, nrow=100, ncol=100))
swi_proj_stack <- stack(pp , swi_proj_p )
names(swi_proj_stack ) <- c("People", "Std.Weighted Intake")

p1 <- levelplot(pp, par.settings = BuRdTheme, main = "Population density", margin = FALSE, scales = list(draw = FALSE))+ addkwa() + txtkwa()

p2 <- levelplot(swi_proj_p, par.settings = BuRdTheme, main = "Project SWI", margin = FALSE, scales = list(draw = FALSE)) + addkwa() + txtkwa()

grid.arrange(p1, p2, ncol=2)
```

#### Projecth health risk approach

Project impacts  
```{r echo=FALSE, message=FALSE}
kwaza_API_proj <- rasterAPI(all_proj)

api_p <- raster_dist_plot(resample(kwaza_API_proj,y = raster(kpext, ncol = 100, nrow=100)), multi = NULL, mn = "Distribution of project API \nfor the project scenario", sb = "182 days") + addkwa() + txtkwa()
```

#### Project burden of disease

```{r echo = FALSE, message=FALSE}
rBoDPM10_proj <- rasterCREP(sl = endlist,
                       pollutant = "PM10", 
                       cconc = all_proj[[grep("pm10", names(all_proj))]], 
                       ppopr = people, 
                       bbase.conc = 10, 
                       rrisk.only = FALSE, 
                       verbose = FALSE, 
                       output = "AM")

rBoDPM10_proj <- aggregateCREPstack(rBoDPM10_proj)

levelplot(resample(rBoDPM10_proj, raster(kpext, nrow=100, ncol = 100)), scales = list(draw = FALSE),
          main = "Burden of disease for PM10 in the project scenario,
given as number of cases per health outcome",
sub = "182 days",
par = BuRdTheme) + addkwa() + txtkwa()

# tabulate total incidences per health outcome
kable(sumIncidences(rBoDPM10_proj), digits = 2, caption = "Estimated burden of disease in the project scenario")
```

# Impact reduction

## Particle precursor approach

The impact of the project scenario in terms of PM10 concentrations are shown below

```{r echo=FALSE, message=FALSE}
PM_impact <- all_base[[grep("pm10", names(all_base))]] - all_proj[[grep("pm10", names(all_proj))]]

raster_dist_plot(resample(PM_impact, raster(extent(all_base), ncol=100, nrow=100)), mn = "Impact of the project activtiy on PM10 concentrations", sb = "Daily differenence between baseline and project scenario over 182 days") +addkwa() + txtkwa() 
```

```{r echo=FALSE}
raster_dist_plot(resample(PM_impact, raster(extent(all_base), ncol=100, nrow=100)), meanonly = TRUE, mn = "Impact of the project activtiy on PM10 concentrations", sb = "Mean daily differenence between baseline and project scenario over 182 days") +addkwa() + txtkwa() 
```

In the same wat as above, the impact of the project scenario on SO~2~ concentrations are shown below. 

```{r echo=FALSE}
SO2_impact <- all_base[[grep("so2", names(all_base))]] - all_proj[[grep("so2", names(all_proj))[1:182]]]

raster_dist_plot(resample(SO2_impact, raster(kpext, ncol=100, nrow=100)), mn = "Impact of the project activtiy on SO2 concentrations (ug/m3)", sb = "Daily differenence between baseline and project scenario over 182 days") +addkwa() + txtkwa() 
```

##Health risk approach

```{r echo=FALSE, message=FALSE}
api_impact <- kwaza_API - kwaza_API_proj
api_impact <- mask(api_impact, masker)
raster_dist_plot(resample(api_impact, raster(extent(all_base), ncol=100, nrow=100)),  multi = NULL,  mn = "Distribution of daily API improvement due to the project scenario",   sb = "182 days") + addkwa() + txtkwa()
```

```{r echo = FALSE}
raster_dist_plot(resample(api_impact, raster(extent(all_base), ncol=100, nrow=100)),  meanonly = TRUE, multi = NULL,  mn = "Mean daily API improvement due to the project scenario",   sb = "182 days") + addkwa() + txtkwa()
```

## Standard weighted intake approach

```{r echo=FALSE, message=FALSE}
swi_base[is.na(swi_base)] <- 0
swi_proj[is.na(swi_proj)] <- 0
swi_impact <- swi_base - swi_proj
swi_impact[swi_impact==0] <- NA
levelplot(resample(swi_impact, raster(kpext, ncol=100, nrow=100)), main = "Impact in terms of reduction in standards weighted intake", sub = "Difference between baseline and project scenarion over 182 days", margin = FALSE, par.settings = BuRdTheme) + addkwa() + txtkwa()
```

## Burden of disease approach 

```{r echo=FALSE, message=FALSE}
rBoDPM10[is.na(rBoDPM10)]  <- 0
rBoDPM10_proj[is.na(rBoDPM10_proj)] <- 0
rBoDPM10_impact <- rBoDPM10 - rBoDPM10_proj
rBoDPM10_impact[rBoDPM10_impact==0] <- NA
rBoDPM10_impact <- resample(rBoDPM10_impact, raster(extent(all_base), nrow=100, ncol=100))
levelplot(rBoDPM10_impact, 
          main = "Impact in terms of disease burden due to the \n implementation of the project activity", 
          sub = "number of cases", 
          par = BuRdTheme, 
          scales = list(draw = FALSE)) + addkwa() + txtkwa()

kable(sumIncidences(rBoDPM10_impact), digits = 2, caption = "Estimated burden of disease improvement within the project boundary")
```

## Impact (number to implement)

#### Impact deficit: particle percursor approach
```{r echo=FALSE, message=FALSE}
eskom_deficit <- eskom_kwa_base - eskom_kwa_proj
plabel <- expression(paste("Daily average ", mu, g/m^{3}, " PM"))

eskom_deficit <- setValues(x = eskom_deficit, values = abs(getValues(eskom_deficit)))

summary(cellStats(eskom_deficit, mean))

eskom_deficit[eskom_deficit == 0] <- 0.000001
names(eskom_deficit) <- paste("Deficit_pm10_24h", 1:nlayers(eskom_deficit))
raster_dist_plot(eskom_deficit, mn = "Daily impact deficit according to the \nparticle precursor approach", sb = plabel) +addkwa()
```

```{r echo=FALSE}
hh_prop_pp <- crop(eskom_deficit, kpext) / crop(hh_24, kpext)

raster_dist_plot(hh_prop_pp, mn = "Proportion of household emission required to offset Eskom emissions") + addkwa() + txtkwa()
```

#### Impact deficit: health risk approach
The 
```{r echo=FALSE, message=FALSE}
api.deficit <- rasterAPI(eskom_deficit)
api.hh <- rasterAPI(hh_24)
api.prop <- api.deficit  / api.hh
raster_dist_plot(crop(api.prop, kpext), mn = "Required proporion of household API", sb = "API index points") + addkwa() + txtkwa()
mean(cellStats(api.deficit, mean))
```


#### Impact deficit: standards weighted mean

```{r echo=FALSE, message=FALSE}
swi.deficit <- SWI(eskom_deficit)
swi.hh <- SWI(hh_24)
swi.prop <- swi.deficit  / swi.hh

levelplot(resample(crop(swi.deficit, kpext),raster(kpext, ncol = 100, nrow = 100)), main = "Impact deficit in the SWI approach", sub = "Standards weighted intake", margin = FALSE, par = BuRdTheme) + addkwa() + txtkwa()

levelplot(resample(crop(swi.prop, kpext), raster(kpext, ncol = 100, nrow = 100)), main = "Required proporion of household SWI", sub = "Standards weighted intake", margin = FALSE, par = BuRdTheme) + addkwa() + txtkwa()

mean(cellStats(swi.deficit, sum))
```

#### Impact deficit: BoD

```{r echo=FALSE, message=FALSE}
bod_deficit <- rasterCREP(sl = endlist,
                       pollutant = c("pm10","so2"), 
                       cconc = eskom_deficit, 
                       ppopr = people, 
                       bbase.conc = 0, 
                       rrisk.only = FALSE, 
                       verbose = FALSE, 
                       output = "AM")
  
bod_deficit <- aggregateCREPstack(bod_deficit)

levelplot(resample(bod_deficit, raster(kpext, ncol = 100, nrow = 100)),
          main = "Burden of disease deficit",
sub = "Cases over 182 days. Reference concentration: 0",
par = BuRdTheme) + addkwa() + txtkwa()
kable(sumIncidences(bod_deficit), digits = 2)
```

```{r echo=FALSE}
bod.hh <- rasterCREP(sl = endlist,
                       pollutant = c("pm10", "so2"), 
                       cconc = resample(crop(hh_24,eskom_deficit), eskom_deficit),
                       ppopr = people, 
                       bbase.conc = 10, 
                       rrisk.only = FALSE, 
                       verbose = FALSE, 
                       output = "AM")

bod.hh <- aggregateCREPstack(bod.hh)

levelplot(bod.hh,
          main = "Burden of disease households", sub = "Cases over 182 days. Reference concentration: 10", par = BuRdTheme) + addkwa() + txtkwa()

kable(sumIncidences(bod.hh), digits = 2)
```

```{r echo=FALSE}
# bod.prop <- bod_deficit  / bod.hh
# 
# maks <- function(x) max(x, na.rm = TRUE)
# 
# bod.prop <- calc(bod.prop, maks)
# 
# levelplot(d.prop, main = "Required % of household required \nto offset the impact of the managed activity (BoD apporach)", sub = "Disease burden", margin = FALSE, par = BuRdTheme) + addkwa() + txtkwa()
# 
# kable(sumIncidences(bod.prop), digits = 2, caption = "BoD improvement within the project boundary due to the project activity")
```


