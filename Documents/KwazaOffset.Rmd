---
title: "Air quality offset calculations for KwaZamokuhle"
author: "Christiaan Pauw, Nova Instituut"
date: "3 December 2015"
output: pdf_document
---
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(raster)
library(rasterVis)
library(knitr)
library(rgdal)
library(pander)

USER <- c("CJP", "AH")[2]

if (USER == "CJP") {
  wd <- "/Users/christiaanpauw/Documents/Rpakette/AQoffset/"
  setwd("/Users/christiaanpauw/Documents/Rpakette/AQoffset/")
  rdir <-  file.path(paste(wd, "R/", sep=""))
  datadir <- file.path(paste(wd, "../../AQ_DATA/Data/", sep = ""))
} 

if (USER == "AH") {
  projdir <- "C:/Users/Alex H/Documents/R/AQoffset/"
  rdir <-  normalizePath(paste(projdir, "R/", sep=""))
  datadir <- normalizePath(paste(projdir, "Data/", sep = ""))
}

source(paste(rdir, "/count_exceed.R", sep=""))
source(paste(rdir, '/raster_dist_sum.R', sep=""))
source(paste(rdir, '/API.R', sep=""))
source(paste(rdir, '/knipNA.R', sep =""))
source(paste(rdir, '/raster_dist_plot.R', sep =""))
source(paste(rdir, '/pop2sp.R', sep =""))
source(paste(rdir, '/rasteriseCensus.R', sep =""))
source(paste(rdir, '/pointifyCensus.R', sep =""))
source(paste(rdir, '/project_boundary.R', sep =""))

new.proj <- "+proj=utm + south + zone=35 ellps=WGS84" 

load(paste(datadir, "/kwaza_household_census.Rda", sep=""))
kwaN <- as.character(KWA@data$SP_NAME)
kwaCoor <- coordinates(KWA)
addkwa <- function(){layer(sp::sp.polygons(KWA, lwd = 0.25))}
txtkwa <- function(){layer(panel.text(x = coordinates(KWA)[,1], y = coordinates(KWA)[,2], label = as.character(KWA@data$SP_NAME), cex = 0.5))}
```

```{r echo=FALSE, message=FALSE}
#remove the other datasets here to save memory
load(paste(datadir, "/kwaza_eskom_24h_camx.Rda", sep = ""))
#load(paste(datadir, "/kwaza_eskom_year_camx.Rda", sep = ""))
load(paste(datadir, "/kwaza_household_energyRaster.Rda", sep=""))
load(paste(datadir, "/kwaza_API_hh.Rda", sep=""))
load(paste(datadir, "/hh_24.Rda", sep=""))
load(paste(datadir, "/EOP-fuel_users.Rda", sep=""))
kpext <- extent(KWA)
```



# Baseline scenario
## Baseline emissions
### Household emission sources

KwaZamokuhle is characterised by a high proportion of households who use coal for domestic cooking and heating. The importance of coal is visible in the results on the question on the main energy carrier for heating from the 2011 Census; these results are shown in the Table 1. 

```{r echo = FALSE, message=FALSE}
kwa_census_df <- KWA@data[, c("SP_Name", "Electricity", "Gas", "Paraffin", "Wood", "Coal", "Animal.dung", "None")]
kwa_census_fuel_df <- data.frame(SP_NAME = KWA@data$SP_NAME, 
                                 Fuel = rowSums(kwa_census_df[,5:7], na.rm = T),
                                 No_fuel = rowSums(kwa_census_df[,c(2:4,8)], na.rm = T))
kable(kwa_census_df, row.names = FALSE, caption = "Main energy carrier for heating from the 2011 Census")
cat("\n")
```

```{r echo=FALSE}
#levelplot(households[[-c(7:8)]], pretty = TRUE, par.settings=BuRdTheme, main = "Number of households by energy carrier \nused for heating: Census 2011", scales=list(draw=FALSE)) + addkwa()
```

It is clear that there are far fewer users of wood and dung than of coal. Because there are very few households who use wood that do not on occasion use coal as well, the responses for coal on the question "Mark ALL the energy carriers that you use for heating?" are used as an estimate for domestic solid fuel use. A summary is provided in Table 2. 
 
```{r echo = FALSE, message=FALSE}
kable(kwa_census_fuel_df, row.names = FALSE, caption = "Solid fuel use for heating from the 2011 Census")
```

It is known however that because the Census asks only a question about the *main* energy carrier, the number of solid fuel users are underestimated. The results of the survey lead to a substantially higher estimate compared to the census. The estimates of coal using households per sub-place derived from the household survey are shown in Table 3. It is clear that the number of coal using households derived from the survey results is substantially higher. 

```{r echo=FALSE, message=FALSE}
kable(data.frame(coal.heat[!is.na(coal.heat[,2]), ], row.names = NULL), caption = "Estimated number of coal using households per subplace with upper and lower bound of the 95% confidence interval")
```

The approximate spatial distribution of the households by coal use are shown below. The high concentration of coal users in the southern and eastern parts of KwaZamokuhle is clear.  

```{r echo = FALSE, message=FALSE}
cat("\n")
pop2sp(coal.heat, raster = TRUE, refres = c(10,10), plot = TRUE, par.settings=BuRdTheme, main = "Number of coal users for heating: \nPoint estimate with 95% CI ", sub="'Yes' is coal use, 'No' is no coal use") + addkwa()
cat("\n")
```

Baseline emissions are calculated from the results of a domestic fuel use survey. The estimates for fuel consumption based on the household survey are shown in Table 4. Winter coal consumption is understandably higher than summer consumption. Once again KwaZamokuhle SP has the highest consumption. 

```{r echo=FALSE, message=FALSE}
names(dta) <- gsub("suburb", "", names(dta))
names(dta) <- gsub("households", "#HH", names(dta))
names(dta) <- gsub("month.kg", "kg/m", names(dta))
names(dta) <- gsub("perc", "%", names(dta))
names(dta) <- gsub("winter.ave", "ave(W)", names(dta))
names(dta) <- gsub("summer.ave", "ave(S)", names(dta))
names(dta) <- gsub("\\.", " ", names(dta))
row.names(dta) <- NULL
pander(dta, split.cells = 40, split.table = Inf, rownames = NULL, caption = "Baseline coal use by Suburb")
```

## Baseline states

The modelled baseline PM10 and SO~2~ resulting from household emissions in KwaZamokuhle is shown below. The baseline emissions from household coal use are summarised below. The tiles represent the 25th and 50th percentiles, the mean and the 75th and 99th percentiles. The last tile in each row represent the standard deviation. 

```{r echo = FALSE, message=FALSE}
raster_dist_plot(hh_24, multi = c("pm10", "so2"), th=BuRdTheme) + addkwa()
```

The distributions of the PM10 and SO~2~ are fairly similar but the concentration of PM10 is modelled to be higher. It is also clear that the concentration of both PM10 and SO~2~ decreases rapidly with distance from the household sources. 

The modelled baseline PM2.5, PM10 and SO~2~ from the industrial point source is shown below.

```{r echo=FALSE}
raster_dist_plot(crop(kwaza_eskom_24h_simple, kpext), multi = c("pm10","pm2.5", "so2")) + addkwa()
```

The count of days where the PM10 concentrations that resulted from household emissions and the industrial point source is modelled to exceed a specified level, is shown below for the baseline scenario. 

```{r echo = FALSE}
hh_pm10_exceed = count_exceed(hh_24, pol = "pm10", min = 75, max = 300, by = 50, knip = FALSE)
levelplot(hh_pm10_exceed, main = "Count of days when PM10 from househols \nexceeded specified concentarion", sub = "182 days", par.settings=BuRdTheme) + addkwa()
```

The exceedances of the daily PM10 standard related to household emissions occur over the southern and eastern side of KwaZamokuhle with the highest exceedance count at every level occurring in KwaZamokuhle SP.

```{r echo=FALSE}
#xl = expression(paste(mu,plain(g/m)^3))
bar_exceed(hh_pm10_exceed, ttl = "Aggregated # of days when PM10 from households \nexceeded specified concentarion")
```

```{r echo = FALSE}
eskom_pm10_exceed = count_exceed(kwaza_eskom_24h_PM_SO2, pol = "pm10", min = 75, max = 300, by = 50, knip = TRUE)
levelplot(crop(eskom_pm10_exceed, kpext), main = "Count of days when PM10 from Eskom \nexceeded specified concentration", sub = "365 days", scales=list(draw=FALSE), par.settings=BuRdTheme) + addkwa()
```

```{r echo=FALSE}
bar_exceed(eskom_pm10_exceed, ttl = "Aggregated of days when PM10 from Eskom \nexceeded specified concentarion")
```

The count of days where SO~2~ concentration that resulted from household emissions is modelled to exceed a specified level, is shown below for the baseline scenario. 

```{r echo=FALSE}
hh_so2_exceed = count_exceed(hh_24, pol = "so2", min = 75, max = 300, by = 50, knip = F)
levelplot(hh_so2_exceed, main = "Count of days when SO2 from households \nexceeded specified concentration", sub = "182 days", par = BuRdTheme, scales=list(draw=FALSE)) + addkwa() + txtkwa()
```

Occurrences of exceedances of the daily SO~2~ standard related to coal combustion from households are less common than that for PM10. The area over which such occurrences are smaller than that of PM10 for every level and the count of exceedances for each level is also less. Once again most exceedances occur in KwaZamokuhle SP. 

```{r echo=FALSE}
bar_exceed(hh_so2_exceed, ttl = "Aggregated count of days when SO2 from \nhouseholds exceeded specified concentration")
```

The count of days where SO~2~ from the industrial point source exceeded the specified level for the baseline scenario is not shown in the previous plot because all values are below the minimum level. 

# Project boundary
The spatial extent of the project boundary is the overlapping extent of the ambient contribution of the baseline emissions above 2 ug/m3 per year or 19 ug/m3 per day in PM10 or SO~2~, and the same for project emissions from the managed activity. Project emissions from the managed activity are the emissions from Eskom in the business-as-usual scenario. Baseline emissions from households are the emissions from households before implementation of the intervention. 

## Application of thresholds to determine project boundary

The baseline emissions from household coal use are summarised below. The tiles represent the 1st, 25th and 50th percentiles, the mean and the 75th and 99th percentiles. The last three tiles represent the standard deviation, inter-quartile range and 99% range of the data. 

```{r echo=FALSE, message=FALSE}
raster_dist_plot(hh_24, mn = "Summary of modelled PM10 concentrations from household \ncoal burning in KwaZamokuhle", sb = "Daily averages over one year") + addkwa()
```


The extent of the impact of household emissions in the baseline scenario above an annual average of 2ug/m3 or an daily average of 19ug/m3 is shown below. Blank cells are outside of the project boundary.

```{r echo = FALSE, message=FALSE}
hh_24 <- project_boundary(r = hh_24, return.mask = TRUE) 
cat("\n")
raster_dist_plot(hh_24, mn = "Definition of the project boundary", sb = "Non-blank areas are where daily or \n annual PM10 exceed the threshold (182 days)") + addkwa() + txtkwa()
```

It is clear from the application of the threshold that, if the modelling is correct, the impact of domestic burning is localised in close proximity to the emissions. The project boundary includes the whole of the main place KwaZamokuhle. Of all the sub-places that make up the main place KwaZamokuhle, the highest mean and maximum concentrations are found in KwaZamokuhle SP. 

## Baseline impact

Baseline impact can be determined using different calculation approaches. Four approaches will be demonstrated. These are: 
1.  Health risk approach
2.  Particle equivalence approach
3.  Standards weighted intake
4.  Burden of disease approach

### Health risk approach

The health risk approach uses an air quality index based on the relative risk of short term mortality associated with every pollutant. Here the pollutants are PM10 and SO~2~, but O~3~ and NO~2~ can potentially be added. The baseline impact represents the combined impact of all pollutants. A summary of the daily API resulting from households is given below.  

```{r echo=FALSE}
kwaza_API <- crop(kwaza_API, extent(masker))
kwaza_API <- mask(kwaza_API, masker)
raster_dist_plot(kwaza_API, multi = NULL, mn = "Distribution of baseline API \nfrom households in KwaZamokuhle", sb = "182 days") + addkwa() + txtkwa()
```

The baseline impact of the industrial point source for the full year is shown below.

```{r echo=FALSE}
raster_dist_plot(rasterAPI(crop(kwaza_eskom_24h_PM_SO2, kpext)), multi = NULL, mn = "KwaZamokuhle baseline API from households", sb = "182 days") + addkwa() + txtkwa()
```

The count of days where the API that resulted from household emissions is modelled to exceed a specified level is shown below for the baseline scenario. 

```{r echo=FALSE}
levelplot(count_exceed(kwaza_API, min = 3, max = 10, by = 1, knip = TRUE) , par = BuRdTheme, scales=list(draw=FALSE), main = "Days in KwaZamokuhle where API \nfrom households exceeded specified level", sub = "182 days") + addkwa() + txtkwa()
```

KwaZamokuhle SP has the highest health risk related to short term exposure.  

### Particle equivalence approach

With sources that have a very localised dispersion, the particle equivalent impact (as PM10 equivalent) of that source is simply the concentration of the PM10 emitted by that source at every receptor; therefore, in the case of household emissions, the baseline impact is the same as the baseline state of PM10 shown above. 

### Standards weighted intake

The standards weighted intake approach is roughly equivalent to a population weighted air pollution index with the index weights determined by the standard. In this way it is related to the health risk approach that also requires population data. 

### Burden of disease approach


# Project scenario

The project scenario is the implementation of a stove exchange for all RDP houses who use coal, where the households exchange their old coal stoves for a full retrofit and LPG.

The estimates of fuel users per house type are shown below.

```{r echo = FALSE}
kable(fuel_house[!is.na(fuel_house[,2]), ])
fh = fuel_house[which(fuel_house[,2] == "Fuel_RDP"), ]
fh$place = unique(fuel_house[,1])[c(1,3:6)]
```

The target for the project activity is therefore between `r colSums(fh[,3:5])["Lower"]`  and `r colSums(fh[,3:5])["Upper"] ` with a point estimate of `r colSums(fh[,3:5])["PointEst"] `

```{r echo=FALSE}
kable(fh, caption = "Implementation targets per sub-place")
```

## Project emissions

### Improvement per household

LPG 100%

Kitchen King = 0.018 * Union * 1.4    * 2 to be conservative ~ 5%

#### Proportion of solid fuel using households reachable by the project



### Project states

### Project impacts





